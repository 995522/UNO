<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer UNO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom on mobile */
        }
        .card {
            width: 80px;
            height: 120px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 2px solid white;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 15px rgba(0,0,0,0.2);
        }
        .card .inner-text {
            background-color: white;
            color: black;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-style: italic;
            transform: rotate(-15deg);
        }
        .card .corner-text {
            position: absolute;
            font-size: 1rem;
        }
        .card .top-left { top: 5px; left: 10px; }
        .card .bottom-right { bottom: 5px; right: 10px; transform: rotate(180deg); }

        .bg-red-uno { background-color: #FF5555; }
        .bg-yellow-uno { background-color: #FFAA00; }
        .bg-green-uno { background-color: #55AA55; }
        .bg-blue-uno { background-color: #5555FF; }
        .bg-black-uno { background: linear-gradient(135deg, #4a4a4a, #1a1a1a); }

        .player-hand {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: -20px; /* Overlap cards */
        }
        .player-hand .card {
            margin: 0 -15px;
        }

        .opponent-hand .card {
            width: 50px;
            height: 75px;
            font-size: 1rem;
        }
        .opponent-hand .card .inner-text { display: none; }
        .opponent-hand .card .corner-text { display: none; }


        .draw-pile .card {
            background: linear-gradient(135deg, #4a4a4a, #1a1a1a);
        }
        .draw-pile .card .inner-text {
            font-size: 1.5rem;
            color: white;
            background: none;
            font-style: normal;
             transform: rotate(0deg);
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .color-picker div {
            width: 60px;
            height: 60px;
            cursor: pointer;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .color-picker div:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-7xl mx-auto hidden">
        <!-- Opponents -->
        <div class="absolute top-4 left-1/2 -translate-x-1/2 w-full px-4 flex justify-center">
             <div id="opponent-top" class="text-center"></div>
        </div>
        <div class="absolute left-4 top-1/2 -translate-y-1/2">
             <div id="opponent-left" class="text-center"></div>
        </div>
        <div class="absolute right-4 top-1/2 -translate-y-1/2">
             <div id="opponent-right" class="text-center"></div>
        </div>

        <!-- Game Table -->
        <div class="flex flex-col items-center justify-center h-full absolute inset-0">
            <div id="game-info" class="text-center mb-4 text-lg"></div>
            <div class="flex items-center space-x-8">
                <div class="draw-pile">
                    <div id="draw-card-pile" class="card" onclick="drawCard()">
                        <div class="inner-text">UNO</div>
                    </div>
                </div>
                <div id="discard-pile" class="w-[80px] h-[120px]"></div>
            </div>
            <div id="game-log" class="mt-4 text-sm text-gray-400 h-12 overflow-y-auto"></div>
        </div>

        <!-- Current Player -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-full px-4 text-center">
            <div id="current-player-info" class="mb-2"></div>
            <div id="player-hand" class="player-hand flex justify-center items-end min-h-[140px]"></div>
             <button id="uno-button" onclick="callUno()" class="mt-4 px-6 py-2 bg-yellow-500 text-black font-bold rounded-lg shadow-lg hover:bg-yellow-400 transition hidden">UNO!</button>
        </div>
    </div>

    <!-- Lobby -->
    <div id="lobby" class="text-center bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
        <h1 class="text-5xl font-bold mb-6 text-yellow-400">UNO Multiplayer</h1>
        <div id="lobby-info" class="mt-6 text-yellow-400 h-6">Connecting to server...</div>
        <div class="space-y-4 mt-4">
            <button id="create-game-btn" onclick="createGame()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg transition disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Create Game</button>
            <div>
                <input type="text" id="join-game-id" placeholder="Enter Game ID" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 disabled:bg-gray-600" disabled>
                <button id="join-game-btn" onclick="joinGame()" class="w-full mt-2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg text-lg transition disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Join Game</button>
            </div>
        </div>
        <div id="player-list" class="mt-4 text-lg"></div>
        <button id="start-game-button" onclick="startGame()" class="mt-4 bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 px-6 rounded-lg text-lg transition hidden">Start Game</button>
    </div>

    <!-- Color Picker Modal -->
    <div id="color-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-bold mb-4 text-black">Choose a color</h2>
            <div class="flex space-x-4 color-picker">
                <div class="bg-red-uno" onclick="selectColor('red')"></div>
                <div class="bg-yellow-uno" onclick="selectColor('yellow')"></div>
                <div class="bg-green-uno" onclick="selectColor('green')"></div>
                <div class="bg-blue-uno" onclick="selectColor('blue')"></div>
            </div>
        </div>
    </div>

    <!-- Winner Modal -->
    <div id="winner-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center text-black">
            <h2 id="winner-message" class="text-4xl font-bold mb-4"></h2>
            <button onclick="resetGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg text-lg transition">Play Again</button>
        </div>
    </div>
    
    <!-- Generic Message Modal -->
    <div id="message-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center text-black">
            <h2 id="message-text" class="text-2xl font-bold mb-4"></h2>
            <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg text-lg transition">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- UI Elements ---
        const lobbyEl = document.getElementById('lobby');
        const gameContainerEl = document.getElementById('game-container');
        const lobbyInfoEl = document.getElementById('lobby-info');
        const playerListEl = document.getElementById('player-list');
        const startGameButton = document.getElementById('start-game-button');
        const playerHandEl = document.getElementById('player-hand');
        const discardPileEl = document.getElementById('discard-pile');
        const gameInfoEl = document.getElementById('game-info');
        const colorModal = document.getElementById('color-modal');
        const winnerModal = document.getElementById('winner-modal');
        const winnerMessageEl = document.getElementById('winner-message');
        const unoButton = document.getElementById('uno-button');
        const gameLogEl = document.getElementById('game-log');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const joinGameInput = document.getElementById('join-game-id');

        // --- Game State ---
        let userId;
        let gameId;
        let playerIndex;
        let gameStateUnsubscribe = null;
        let wildCardToPlay = null;
        let db, auth;

        // --- Helper Functions ---
        const showLobbyMessage = (message, isError = false) => {
            lobbyInfoEl.textContent = message;
            lobbyInfoEl.className = isError ? 'mt-6 text-red-400 h-6' : 'mt-6 text-yellow-400 h-6';
        };
        
        const showMessageModal = (message) => {
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
        };

        // --- Main Initialization ---
        const initializeGame = async () => {
            try {
                // PASTE YOUR FIREBASE CONFIGURATION HERE
                const firebaseConfig = {
                apiKey: "AIzaSyDIKfdJuJNwQAcG-Q7AEt3NGJ6SLHfZ-1o",
                authDomain: "my-uno-game-9da37.firebaseapp.com",
                projectId: "my-uno-game-9da37",
                storageBucket: "my-uno-game-9da37.firebasestorage.app",
                messagingSenderId: "1055351318664",
                appId: "1:1055351318664:web:4aa352b1183ef2fe25573d"
                };

                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                showLobbyMessage("Authenticating...", false);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with User ID:", userId);
                        createGameBtn.disabled = false;
                        joinGameBtn.disabled = false;
                        joinGameInput.disabled = false;
                        showLobbyMessage('Ready! Create or join a game.', false);
                    }
                });

                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Initialization failed:", error);
                showLobbyMessage('Error: Could not connect to the server.', true);
                createGameBtn.disabled = true;
                joinGameBtn.disabled = true;
                joinGameInput.disabled = true;
            }
        };
        
        initializeGame();

        // --- Game Logic Functions ---
        const createDeck = () => {
            const colors = ['red', 'yellow', 'green', 'blue'];
            const values = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'skip', 'reverse', 'draw2'];
            const special = ['wild', 'wild4'];
            let deck = [];

            colors.forEach(color => {
                values.forEach(value => {
                    deck.push({ color, value });
                    if (value !== '0') {
                        deck.push({ color, value });
                    }
                });
            });

            for (let i = 0; i < 4; i++) {
                special.forEach(value => {
                    deck.push({ color: 'black', value });
                });
            }
            return deck;
        };

        const shuffleDeck = (deck) => {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        };

        const canPlayCard = (card, topCard) => {
            if (!topCard) return true; // First card
            return card.color === 'black' || card.color === topCard.color || card.value === topCard.value;
        };

        // --- Firebase Functions ---
        window.createGame = async () => {
            if (!userId) {
                showLobbyMessage("Not connected. Please wait.", true);
                return;
            }
            showLobbyMessage("Creating game...", false);
            gameId = Math.random().toString(36).substring(2, 7).toUpperCase();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
            const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameId);

            const newGame = {
                players: [{ id: userId, name: `Player 1`, unoCalled: false }],
                deck: [],
                discardPile: [],
                currentPlayerIndex: 0,
                direction: 1, // 1 for clockwise, -1 for counter-clockwise
                status: 'lobby',
                createdAt: serverTimestamp(),
                log: [`Game ${gameId} created.`]
            };

            await setDoc(gameRef, newGame);
            joinGame(gameId);
        };

        window.joinGame = async (id) => {
            const gameIdToJoin = id || document.getElementById('join-game-id').value.toUpperCase();
            if (!gameIdToJoin) {
                showLobbyMessage("Please enter a Game ID.", true);
                return;
            }
            if (!userId) {
                showLobbyMessage("Not connected. Please wait.", true);
                return;
            }
            showLobbyMessage(`Joining game ${gameIdToJoin}...`, false);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
            const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameIdToJoin);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists()) {
                const gameData = gameSnap.data();
                if (gameData.players.some(p => p.id === userId)) {
                     // Player is already in the game, just subscribe them
                } else {
                    if (gameData.players.length >= 4) {
                        showLobbyMessage("This game is full.", true);
                        return;
                    }
                    if (gameData.status !== 'lobby') {
                        showLobbyMessage("This game has already started.", true);
                        return;
                    }
                    const newPlayer = { id: userId, name: `Player ${gameData.players.length + 1}`, unoCalled: false };
                    await updateDoc(gameRef, {
                        players: [...gameData.players, newPlayer]
                    });
                }
                gameId = gameIdToJoin;
                subscribeToGameState();
            } else {
                showLobbyMessage("Game not found.", true);
            }
        };

        const subscribeToGameState = () => {
            if (gameStateUnsubscribe) gameStateUnsubscribe();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
            const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameId);
            gameStateUnsubscribe = onSnapshot(gameRef, (doc) => {
                if (doc.exists()) {
                    const gameState = doc.data();
                    updateUI(gameState);
                } else {
                    showMessageModal("The game session has ended.");
                    resetToLobby();
                }
            });
        };

        window.startGame = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
            const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) return;

            const gameData = gameSnap.data();
            if (gameData.players.length < 2) {
                showLobbyMessage("You need at least 2 players to start.", true);
                return;
            }

            let deck = shuffleDeck(createDeck());
            const players = gameData.players.map(p => ({ ...p, hand: [] }));

            for (let i = 0; i < 7; i++) {
                players.forEach(player => {
                    player.hand.push(deck.pop());
                });
            }
            
            let firstCard = deck.pop();
            while(firstCard.value === 'wild4') {
                deck.push(firstCard);
                deck = shuffleDeck(deck);
                firstCard = deck.pop();
            }

            const discardPile = [firstCard];

            await updateDoc(gameRef, {
                status: 'playing',
                deck,
                players,
                discardPile,
                currentPlayerIndex: 0,
                direction: 1,
                log: [...gameData.log, "Game started!"]
            });
        };
        
        window.playCard = async (cardIndex) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
            const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) return;
            let gameState = gameSnap.data();
            
            if (gameState.currentPlayerIndex !== playerIndex) {
                console.log("Not your turn!");
                return;
            }

            const player = gameState.players[playerIndex];
            const card = player.hand[cardIndex];
            const topCard = gameState.discardPile[gameState.discardPile.length - 1];

            if (canPlayCard(card, topCard)) {
                player.hand.splice(cardIndex, 1);
                gameState.discardPile.push(card);
                gameState.players[playerIndex] = player;
                gameState.log.push(`${player.name} played a ${card.color} ${card.value}.`);
                if (gameState.log.length > 10) gameState.log.shift();

                if (card.color === 'black') {
                    wildCardToPlay = card;
                    colorModal.classList.remove('hidden');
                    await updateDoc(gameRef, {
                        players: gameState.players,
                        discardPile: gameState.discardPile,
                        log: gameState.log
                    });
                    return;
                }
                
                await endTurn(gameState, card);

            } else {
                console.log("Cannot play this card");
            }
        };
        
        const endTurn = async (gameState, playedCard) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
            const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameId);
            const numPlayers = gameState.players.length;
            let nextPlayerIndex = gameState.currentPlayerIndex;
            
            if (gameState.players[playerIndex].hand.length === 0) {
                await updateDoc(gameRef, {
                    status: 'finished',
                    winner: gameState.players[playerIndex].name,
                    log: [...gameState.log, `${gameState.players[playerIndex].name} wins!`]
                });
                return;
            }

            if (gameState.players[playerIndex].hand.length === 1 && !gameState.players[playerIndex].unoCalled) {
                 gameState.log.push(`${gameState.players[playerIndex].name} forgot to call UNO! Draws 2 cards.`);
                 for(let i=0; i<2; i++) {
                    if (gameState.deck.length === 0) gameState = reshuffleDiscardPile(gameState);
                    gameState.players[playerIndex].hand.push(gameState.deck.pop());
                 }
            } else if (gameState.players[playerIndex].hand.length > 1) {
                gameState.players[playerIndex].unoCalled = false;
            }

            switch(playedCard.value) {
                case 'skip':
                    nextPlayerIndex = (nextPlayerIndex + gameState.direction * 2 + numPlayers) % numPlayers;
                    gameState.log.push(`Next player is skipped!`);
                    break;
                case 'reverse':
                    gameState.direction *= -1;
                    const multiplier = numPlayers === 2 ? 2 : 1;
                    nextPlayerIndex = (nextPlayerIndex + gameState.direction * multiplier + numPlayers) % numPlayers;
                    gameState.log.push(`Game direction reversed!`);
                    break;
                case 'draw2':
                    nextPlayerIndex = (nextPlayerIndex + gameState.direction + numPlayers) % numPlayers;
                    const victimDraw2 = gameState.players[nextPlayerIndex];
                    gameState.log.push(`${victimDraw2.name} draws 2 cards and is skipped!`);
                    for(let i=0; i<2; i++) {
                        if (gameState.deck.length === 0) gameState = reshuffleDiscardPile(gameState);
                        victimDraw2.hand.push(gameState.deck.pop());
                    }
                    nextPlayerIndex = (nextPlayerIndex + gameState.direction + numPlayers) % numPlayers;
                    break;
                case 'wild4':
                    nextPlayerIndex = (nextPlayerIndex + gameState.direction + numPlayers) % numPlayers;
                    const victimDraw4 = gameState.players[nextPlayerIndex];
                    gameState.log.push(`${victimDraw4.name} draws 4 cards and is skipped!`);
                    for(let i=0; i<4; i++) {
                        if (gameState.deck.length === 0) gameState = reshuffleDiscardPile(gameState);
                        victimDraw4.hand.push(gameState.deck.pop());
                    }
                    nextPlayerIndex = (nextPlayerIndex + gameState.direction + numPlayers) % numPlayers;
                    break;
                default:
                    nextPlayerIndex = (nextPlayerIndex + gameState.direction + numPlayers) % numPlayers;
                    break;
            }
            
            await updateDoc(gameRef, {
                players: gameState.players,
                deck: gameState.deck,
                discardPile: gameState.discardPile,
                currentPlayerIndex: nextPlayerIndex,
                direction: gameState.direction,
                log: gameState.log
            });
        };

        window.drawCard = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
            const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) return;
            let gameState = gameSnap.data();

            if (gameState.currentPlayerIndex !== playerIndex) return;
            
            if (gameState.deck.length === 0) {
                gameState = reshuffleDiscardPile(gameState);
            }

            const drawnCard = gameState.deck.pop();
            gameState.players[playerIndex].hand.push(drawnCard);
            gameState.log.push(`${gameState.players[playerIndex].name} drew a card.`);

            const nextPlayerIndex = (gameState.currentPlayerIndex + gameState.direction + gameState.players.length) % gameState.players.length;

            await updateDoc(gameRef, {
                deck: gameState.deck,
                players: gameState.players,
                currentPlayerIndex: nextPlayerIndex,
                log: gameState.log
            });
        };
        
        const reshuffleDiscardPile = (gameState) => {
            const topCard = gameState.discardPile.pop();
            gameState.deck = shuffleDeck(gameState.discardPile);
            gameState.discardPile = [topCard];
            gameState.log.push("Discard pile reshuffled into the deck.");
            return gameState;
        };

        window.selectColor = async (color) => {
            colorModal.classList.add('hidden');
            if (!wildCardToPlay) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
            const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) return;
            let gameState = gameSnap.data();

            let topCard = gameState.discardPile[gameState.discardPile.length - 1];
            topCard.color = color; 
            
            gameState.log.push(`${gameState.players[playerIndex].name} chose ${color}.`);

            await updateDoc(gameRef, { discardPile: gameState.discardPile, log: gameState.log });

            await endTurn(gameState, wildCardToPlay);
            wildCardToPlay = null;
        };
        
        window.callUno = async () => {
             const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
             const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameId);
             const gameSnap = await getDoc(gameRef);
             if (!gameSnap.exists()) return;
             let gameState = gameSnap.data();
             
             gameState.players[playerIndex].unoCalled = true;
             
             await updateDoc(gameRef, { players: gameState.players });
             
             unoButton.classList.add('hidden');
        };

        window.resetGame = async () => {
            winnerModal.classList.add('hidden');
            if (playerIndex === 0) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-uno-app';
                const gameRef = doc(db, `artifacts/${appId}/public/data/unoGames`, gameId);
                await updateDoc(gameRef, { status: 'lobby' });
            }
        };

        // --- UI Update Functions ---
        const updateUI = (gameState) => {
            if (gameState.status === 'lobby') {
                resetToLobby();
                lobbyInfoEl.innerHTML = `Game ID: <strong class="text-yellow-400 text-xl">${gameId}</strong> (Share with friends)`;
                const playerNames = gameState.players.map(p => `<div class="p-2 bg-gray-700 rounded">${p.name}</div>`).join('');
                playerListEl.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">${playerNames}</div>`;
                
                playerIndex = gameState.players.findIndex(p => p.id === userId);
                if (playerIndex === 0) { // Host
                    startGameButton.classList.remove('hidden');
                }
            } else {
                lobbyEl.classList.add('hidden');
                gameContainerEl.classList.remove('hidden');

                playerIndex = gameState.players.findIndex(p => p.id === userId);
                if (playerIndex === -1) return;

                renderHands(gameState.players);
                renderDiscardPile(gameState.discardPile);
                updateGameInfo(gameState);
                updateGameLog(gameState.log);

                const myHand = gameState.players[playerIndex].hand;
                // Show the UNO button when the player has exactly two cards
                if (myHand.length === 2) {
                    unoButton.classList.remove('hidden');
                } else {
                    unoButton.classList.add('hidden');
                }

                if (gameState.status === 'finished') {
                    winnerMessageEl.textContent = `${gameState.winner} wins the game!`;
                    winnerModal.classList.remove('hidden');
                }
            }
        };

        const renderHands = (players) => {
            playerHandEl.innerHTML = '';
            const myHand = players[playerIndex].hand;
            myHand.forEach((card, index) => {
                const cardEl = createCardElement(card);
                cardEl.onclick = () => playCard(index);
                playerHandEl.appendChild(cardEl);
            });
            document.getElementById('current-player-info').textContent = `${players[playerIndex].name} (You)`;

            const opponentPositions = ['top', 'right', 'left'];
            const opponents = players.filter((_, i) => i !== playerIndex);

            opponentPositions.forEach(pos => {
                const el = document.getElementById(`opponent-${pos}`);
                if (el) el.innerHTML = '';
            });

            opponents.forEach((opponent, i) => {
                const pos = opponentPositions[i % opponentPositions.length];
                const opponentEl = document.getElementById(`opponent-${pos}`);
                if (opponentEl) {
                    opponentEl.innerHTML = `
                        <div class="font-bold">${opponent.name}</div>
                        <div class="flex justify-center gap-1 mt-1 opponent-hand">
                            ${opponent.hand.map(() => `<div class="card bg-gray-700"></div>`).join('')}
                        </div>
                    `;
                }
            });
        };

        const renderDiscardPile = (pile) => {
            discardPileEl.innerHTML = '';
            if (pile.length > 0) {
                const topCard = pile[pile.length - 1];
                const cardEl = createCardElement(topCard);
                cardEl.style.cursor = 'default';
                cardEl.style.transform = 'none';
                discardPileEl.appendChild(cardEl);
            }
        };

        const updateGameInfo = (gameState) => {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const turnText = currentPlayer.id === userId ? "Your Turn" : `${currentPlayer.name}'s Turn`;
            const directionText = gameState.direction === 1 ? 'Clockwise' : 'Counter-Clockwise';
            gameInfoEl.innerHTML = `
                <div class="font-bold text-2xl ${currentPlayer.id === userId ? 'text-green-400' : 'text-red-400'}">${turnText}</div>
                <div>Cards in Deck: ${gameState.deck.length} | Direction: ${directionText}</div>
            `;
        };
        
        const updateGameLog = (log) => {
            gameLogEl.innerHTML = log.slice().reverse().map(entry => `<div>${entry}</div>`).join('');
            gameLogEl.scrollTop = 0;
        };

        const createCardElement = (card) => {
            const el = document.createElement('div');
            el.className = 'card';
            const colorClass = `bg-${card.color}-uno`;
            el.classList.add(colorClass);

            let valueText = card.value;
            if (card.value === 'skip') valueText = '⊘';
            if (card.value === 'reverse') valueText = '⇄';
            if (card.value === 'draw2') valueText = '+2';
            if (card.value === 'wild') valueText = 'W';
            if (card.value === 'wild4') valueText = '+4';

            el.innerHTML = `
                <span class="corner-text top-left">${valueText}</span>
                <div class="inner-text">${valueText}</div>
                <span class="corner-text bottom-right">${valueText}</span>
            `;
            return el;
        };

        const resetToLobby = () => {
            if(gameStateUnsubscribe) {
                gameStateUnsubscribe();
                gameStateUnsubscribe = null;
            }
            lobbyEl.classList.remove('hidden');
            gameContainerEl.classList.add('hidden');
            playerListEl.innerHTML = '';
            startGameButton.classList.add('hidden');
            document.getElementById('join-game-id').value = '';
            showLobbyMessage('Ready! Create or join a game.', false);
        };

    </script>
</body>
</html>
